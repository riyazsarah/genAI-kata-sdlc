{% extends "base.html" %}

{% block title %}Log In - {{ app_name }}{% endblock %}

{% block extra_head %}
<style>
    /* Login Role Tabs */
    .login-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        background: var(--background);
        padding: 0.25rem;
        border-radius: var(--radius-lg);
    }

    .login-tab {
        flex: 1;
        padding: 0.75rem 1rem;
        border: none;
        background: transparent;
        border-radius: var(--radius);
        font-size: 0.9375rem;
        font-weight: 600;
        color: var(--text-light);
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .login-tab:hover {
        color: var(--text);
    }

    .login-tab.active {
        background: var(--white);
        color: var(--primary);
        box-shadow: var(--shadow-sm);
    }

    .login-tab svg {
        width: 18px;
        height: 18px;
    }

    /* Role-specific colors */
    .login-tab[data-role="consumer"].active {
        color: var(--primary);
    }

    .login-tab[data-role="farmer"].active {
        color: #f97316;
    }

    .login-tab[data-role="admin"].active {
        color: #8b5cf6;
    }

    /* Role indicator badge */
    .role-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: var(--radius);
        margin-bottom: 1rem;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .role-indicator.consumer {
        background: rgba(34, 197, 94, 0.1);
        color: var(--primary);
    }

    .role-indicator.farmer {
        background: rgba(249, 115, 22, 0.1);
        color: #f97316;
    }

    .role-indicator.admin {
        background: rgba(139, 92, 246, 0.1);
        color: #8b5cf6;
    }

    /* Auth card wider for tabs */
    .auth-card.with-tabs {
        max-width: 480px;
    }

    /* Register links */
    .register-options {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border);
        text-align: center;
    }

    .register-options p {
        color: var(--text-light);
        margin-bottom: 0.75rem;
        font-size: 0.9375rem;
    }

    .register-links {
        display: flex;
        gap: 0.75rem;
        justify-content: center;
    }

    .register-link {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.5rem 1rem;
        border-radius: var(--radius);
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        transition: var(--transition);
    }

    .register-link.consumer {
        background: rgba(34, 197, 94, 0.1);
        color: var(--primary);
    }

    .register-link.consumer:hover {
        background: rgba(34, 197, 94, 0.2);
    }

    .register-link.farmer {
        background: rgba(249, 115, 22, 0.1);
        color: #f97316;
    }

    .register-link.farmer:hover {
        background: rgba(249, 115, 22, 0.2);
    }

    /* Role description */
    .role-description {
        font-size: 0.8125rem;
        color: var(--text-light);
        text-align: center;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card with-tabs">
        <h1>Welcome Back</h1>
        <p class="auth-subtitle">Choose your account type and log in</p>

        <!-- Role Tabs -->
        <div class="login-tabs">
            <button type="button" class="login-tab active" data-role="consumer">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                Consumer
            </button>
            <button type="button" class="login-tab" data-role="farmer">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
                Farmer
            </button>
            <button type="button" class="login-tab" data-role="admin">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
                Admin
            </button>
        </div>

        <!-- Role Indicator -->
        <div class="role-indicator consumer" id="role-indicator">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
            </svg>
            <span id="role-text">Logging in as Consumer</span>
        </div>

        <p class="role-description" id="role-description">
            Browse and purchase fresh products from local farmers
        </p>

        <div id="error-message" class="alert alert-error" style="display: none;"></div>
        <div id="success-message" class="alert alert-success" style="display: none;"></div>

        <form id="login-form" class="auth-form">
            <input type="hidden" id="login-role" value="consumer">

            <div class="form-group">
                <label for="email">Email Address</label>
                <input
                    type="email"
                    id="email"
                    name="email"
                    required
                    placeholder="Enter your email"
                    autocomplete="email"
                >
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <input
                    type="password"
                    id="password"
                    name="password"
                    required
                    placeholder="Enter your password"
                    autocomplete="current-password"
                >
            </div>

            <div class="form-options">
                <a href="/forgot-password" class="forgot-password-link">Forgot password?</a>
            </div>

            <button type="submit" class="btn btn-primary btn-block" id="login-btn">
                <span id="btn-text">Log In</span>
                <span id="btn-loading" style="display: none;">Logging in...</span>
            </button>
        </form>

        <!-- Register Options -->
        <div class="register-options">
            <p>Don't have an account?</p>
            <div class="register-links">
                <a href="/register" class="register-link consumer">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    Sign up as Consumer
                </a>
                <a href="/register/farmer" class="register-link farmer">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                    </svg>
                    Sign up as Farmer
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Check if user is already logged in - redirect based on role
    (function() {
        const accessToken = localStorage.getItem('access_token');
        const userStr = localStorage.getItem('user');

        if (accessToken && userStr) {
            try {
                const user = JSON.parse(userStr);
                redirectBasedOnRole(user.role);
            } catch (e) {
                // Invalid data, stay on login page
            }
            return;
        }
    })();

    function redirectBasedOnRole(role) {
        switch(role) {
            case 'admin':
                window.location.href = '/admin/dashboard';
                break;
            case 'farmer':
                window.location.href = '/farmer/dashboard';
                break;
            default:
                window.location.href = '/dashboard';
        }
    }

    // Tab switching
    const tabs = document.querySelectorAll('.login-tab');
    const roleIndicator = document.getElementById('role-indicator');
    const roleText = document.getElementById('role-text');
    const roleDescription = document.getElementById('role-description');
    const loginRoleInput = document.getElementById('login-role');
    const loginBtn = document.getElementById('login-btn');

    const roleConfig = {
        consumer: {
            text: 'Logging in as Consumer',
            description: 'Browse and purchase fresh products from local farmers',
            btnClass: 'btn-primary'
        },
        farmer: {
            text: 'Logging in as Farmer',
            description: 'Manage your farm products and connect with customers',
            btnClass: 'btn-farmer'
        },
        admin: {
            text: 'Logging in as Admin',
            description: 'Access administrative controls and manage the platform',
            btnClass: 'btn-admin'
        }
    };

    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const role = this.dataset.role;

            // Update active tab
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            // Update role indicator
            roleIndicator.className = 'role-indicator ' + role;
            roleText.textContent = roleConfig[role].text;
            roleDescription.textContent = roleConfig[role].description;

            // Update hidden input
            loginRoleInput.value = role;

            // Update button style
            loginBtn.className = 'btn btn-block';
            if (role === 'farmer') {
                loginBtn.style.background = '#f97316';
                loginBtn.style.borderColor = '#f97316';
            } else if (role === 'admin') {
                loginBtn.style.background = '#8b5cf6';
                loginBtn.style.borderColor = '#8b5cf6';
            } else {
                loginBtn.style.background = '';
                loginBtn.style.borderColor = '';
                loginBtn.classList.add('btn-primary');
            }
        });
    });

    // Form submission
    const form = document.getElementById('login-form');
    const errorDiv = document.getElementById('error-message');
    const successDiv = document.getElementById('success-message');
    const btnText = document.getElementById('btn-text');
    const btnLoading = document.getElementById('btn-loading');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Hide previous messages
        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';

        // Show loading state
        btnText.style.display = 'none';
        btnLoading.style.display = 'inline';
        form.querySelector('button').disabled = true;

        const selectedRole = loginRoleInput.value;
        const formData = {
            email: document.getElementById('email').value,
            password: document.getElementById('password').value
        };

        try {
            const response = await fetch('/api/v1/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (response.ok) {
                const userRole = data.user.role || 'consumer';

                // Validate role matches selected tab
                if (selectedRole !== userRole) {
                    let expectedRoleName = selectedRole.charAt(0).toUpperCase() + selectedRole.slice(1);
                    let actualRoleName = userRole.charAt(0).toUpperCase() + userRole.slice(1);
                    errorDiv.textContent = 'This account is registered as ' + actualRoleName + ', not ' + expectedRoleName + '. Please select the correct login type.';
                    errorDiv.style.display = 'block';
                    return;
                }

                // Store tokens
                localStorage.setItem('access_token', data.token.access_token);
                localStorage.setItem('refresh_token', data.token.refresh_token);
                localStorage.setItem('user', JSON.stringify(data.user));

                successDiv.textContent = 'Login successful! Redirecting...';
                successDiv.style.display = 'block';

                // Redirect based on role after a short delay
                setTimeout(() => {
                    redirectBasedOnRole(userRole);
                }, 1000);
            } else {
                errorDiv.textContent = data.detail || 'Login failed. Please try again.';
                errorDiv.style.display = 'block';
            }
        } catch (error) {
            errorDiv.textContent = 'An error occurred. Please try again later.';
            errorDiv.style.display = 'block';
        } finally {
            // Reset button state
            btnText.style.display = 'inline';
            btnLoading.style.display = 'none';
            form.querySelector('button').disabled = false;
        }
    });
</script>
{% endblock %}

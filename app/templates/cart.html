{% extends "base.html" %}

{% block title %}Shopping Cart - {{ app_name }}{% endblock %}

{% block extra_head %}
<style>
    .cart-page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
        min-height: calc(100vh - 200px);
    }

    .cart-header {
        margin-bottom: 2rem;
    }

    .cart-header h1 {
        font-size: 2rem;
        color: #1e293b;
        font-weight: 700;
    }

    .cart-header .item-count {
        color: #64748b;
        font-weight: 400;
    }

    .cart-container {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 2rem;
        align-items: start;
    }

    @media (max-width: 900px) {
        .cart-container {
            grid-template-columns: 1fr;
        }
    }

    /* Cart Items */
    .cart-items {
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        overflow: hidden;
    }

    .cart-item {
        display: flex;
        gap: 1.5rem;
        padding: 1.5rem;
        border-bottom: 1px solid #e2e8f0;
        transition: background 0.2s;
    }

    .cart-item:last-child {
        border-bottom: none;
    }

    .cart-item:hover {
        background: #f8fafc;
    }

    .cart-item-image {
        width: 100px;
        height: 100px;
        border-radius: 12px;
        object-fit: cover;
        background: #f1f5f9;
        flex-shrink: 0;
        border: 1px solid #e2e8f0;
    }

    .cart-item-details {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .cart-item-name {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1e293b;
    }

    .cart-item-category {
        font-size: 0.8rem;
        color: #22c55e;
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .cart-item-farm {
        font-size: 0.85rem;
        color: #64748b;
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }

    .cart-item-farm svg {
        color: #94a3b8;
    }

    .cart-item-unit-price {
        font-size: 0.875rem;
        color: #64748b;
    }

    .cart-item-stock {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        display: inline-block;
        width: fit-content;
    }

    .cart-item-stock.in-stock {
        background: #dcfce7;
        color: #166534;
    }

    .cart-item-stock.low {
        background: #fef3c7;
        color: #92400e;
    }

    .cart-item-stock.out {
        background: #fee2e2;
        color: #991b1b;
    }

    .cart-item-actions {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        justify-content: space-between;
        min-width: 150px;
        gap: 0.75rem;
    }

    .cart-item-subtotal {
        font-size: 1.375rem;
        font-weight: 700;
        color: #22c55e;
    }

    .quantity-controls {
        display: flex;
        align-items: center;
        gap: 0;
        background: #f1f5f9;
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid #e2e8f0;
    }

    .quantity-btn {
        width: 40px;
        height: 40px;
        border: none;
        background: transparent;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        color: #1e293b;
        font-size: 1.25rem;
        font-weight: 500;
    }

    .quantity-btn:hover:not(:disabled) {
        background: #22c55e;
        color: white;
    }

    .quantity-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .quantity-value {
        min-width: 48px;
        text-align: center;
        font-weight: 600;
        font-size: 1rem;
        color: #1e293b;
        background: white;
        padding: 0.5rem;
    }

    .remove-btn {
        background: none;
        border: none;
        color: #ef4444;
        cursor: pointer;
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.35rem;
        transition: all 0.2s;
        border-radius: 6px;
    }

    .remove-btn:hover {
        background: #fef2f2;
    }

    /* Order Summary */
    .order-summary {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        padding: 1.75rem;
        position: sticky;
        top: 100px;
        border: 1px solid #e2e8f0;
    }

    .order-summary h2 {
        font-size: 1.25rem;
        color: #1e293b;
        margin: 0 0 1.5rem 0;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e2e8f0;
        font-weight: 700;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.875rem;
        font-size: 0.95rem;
    }

    .summary-row .label {
        color: #64748b;
    }

    .summary-row .value {
        font-weight: 600;
        color: #1e293b;
    }

    .summary-row.total {
        margin-top: 1.25rem;
        padding-top: 1.25rem;
        border-top: 2px dashed #e2e8f0;
    }

    .summary-row.total .label,
    .summary-row.total .value {
        font-size: 1.35rem;
        font-weight: 700;
    }

    .summary-row.total .value {
        color: #22c55e;
    }

    .checkout-btn {
        width: 100%;
        padding: 1rem 1.5rem;
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        margin-top: 1.5rem;
        transition: all 0.3s;
        box-shadow: 0 4px 14px rgba(34, 197, 94, 0.35);
    }

    .checkout-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(34, 197, 94, 0.45);
    }

    .checkout-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .continue-shopping {
        display: block;
        text-align: center;
        margin-top: 1rem;
        color: #64748b;
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        transition: color 0.2s;
    }

    .continue-shopping:hover {
        color: #22c55e;
    }

    .clear-cart-btn {
        width: 100%;
        padding: 0.75rem;
        background: transparent;
        border: 1.5px solid #fca5a5;
        color: #ef4444;
        border-radius: 10px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        margin-top: 0.75rem;
        transition: all 0.2s;
    }

    .clear-cart-btn:hover {
        background: #ef4444;
        color: white;
        border-color: #ef4444;
    }

    /* Empty Cart */
    .empty-cart {
        text-align: center;
        padding: 4rem 2rem;
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .empty-cart svg {
        width: 120px;
        height: 120px;
        color: #cbd5e1;
        margin-bottom: 1.5rem;
    }

    .empty-cart h2 {
        font-size: 1.5rem;
        color: #1e293b;
        margin-bottom: 0.5rem;
    }

    .empty-cart p {
        color: #64748b;
        margin-bottom: 1.5rem;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }

    /* Loading State */
    .cart-loading {
        text-align: center;
        padding: 4rem 2rem;
    }

    .spinner {
        width: 48px;
        height: 48px;
        border: 4px solid #e2e8f0;
        border-top-color: #22c55e;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Stock Issues Alert */
    .stock-issues {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1.25rem;
    }

    .stock-issues h4 {
        color: #dc2626;
        margin: 0 0 0.5rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
    }

    .stock-issues ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .stock-issues li {
        font-size: 0.8rem;
        color: #7f1d1d;
        padding: 0.25rem 0;
    }

    /* Auth required */
    .auth-required {
        text-align: center;
        padding: 4rem 2rem;
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        max-width: 500px;
        margin: 2rem auto;
    }

    .auth-required svg {
        color: #cbd5e1;
        margin-bottom: 1rem;
    }

    .auth-required h2 {
        margin-bottom: 0.5rem;
        color: #1e293b;
    }

    .auth-required p {
        color: #64748b;
        margin-bottom: 1.5rem;
    }

    .auth-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
    }

    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        color: white;
        border-radius: 10px;
        z-index: 1000;
        animation: slideIn 0.3s ease;
        font-weight: 500;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .toast-success {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    }

    .toast-error {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .toast-info {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .hidden {
        display: none !important;
    }

    /* Mobile adjustments */
    @media (max-width: 600px) {
        .cart-page {
            padding: 1rem;
        }

        .cart-item {
            flex-direction: column;
            gap: 1rem;
        }

        .cart-item-image {
            width: 100%;
            height: 180px;
        }

        .cart-item-actions {
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .cart-item-subtotal {
            order: 1;
        }

        .quantity-controls {
            order: 2;
        }

        .remove-btn {
            order: 3;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="cart-page">
    <div class="cart-header">
        <h1>Shopping Cart <span class="item-count" id="header-item-count"></span></h1>
    </div>

    <!-- Auth Required State -->
    <div class="auth-required hidden" id="auth-required">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 16v-4M12 8h.01"/>
        </svg>
        <h2>Sign in to view your cart</h2>
        <p>Please log in or create an account to access your shopping cart.</p>
        <div class="auth-buttons">
            <a href="/login" class="btn btn-primary">Log In</a>
            <a href="/register" class="btn btn-ghost">Sign Up</a>
        </div>
    </div>

    <!-- Loading State -->
    <div class="cart-loading" id="cart-loading">
        <div class="spinner"></div>
        <p>Loading your cart...</p>
    </div>

    <!-- Empty Cart State -->
    <div class="empty-cart hidden" id="empty-cart">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M2 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
        </svg>
        <h2>Your cart is empty</h2>
        <p>Looks like you haven't added any products yet. Start shopping to fill your cart with fresh, local goods!</p>
        <a href="/shop" class="btn btn-primary">Browse Products</a>
    </div>

    <!-- Cart Content -->
    <div class="cart-container hidden" id="cart-content">
        <div class="cart-items" id="cart-items">
            <!-- Cart items will be populated here -->
        </div>

        <div class="order-summary">
            <h2>Order Summary</h2>

            <div id="stock-issues-container"></div>

            <div class="summary-row">
                <span class="label">Subtotal</span>
                <span class="value" id="summary-subtotal">$0.00</span>
            </div>
            <div class="summary-row">
                <span class="label">Tax (8%)</span>
                <span class="value" id="summary-tax">$0.00</span>
            </div>
            <div class="summary-row total">
                <span class="label">Total</span>
                <span class="value" id="summary-total">$0.00</span>
            </div>

            <button class="checkout-btn" id="checkout-btn">
                Proceed to Checkout
            </button>

            <a href="/shop" class="continue-shopping">Continue Shopping</a>

            <button class="clear-cart-btn" id="clear-cart-btn">
                Clear Cart
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function() {
    var API_BASE = '/api/v1/cart';
    var currentCart = null;

    // DOM Elements
    var authRequired = document.getElementById('auth-required');
    var cartLoading = document.getElementById('cart-loading');
    var emptyCart = document.getElementById('empty-cart');
    var cartContent = document.getElementById('cart-content');
    var cartItemsContainer = document.getElementById('cart-items');
    var headerItemCount = document.getElementById('header-item-count');
    var checkoutBtn = document.getElementById('checkout-btn');
    var clearCartBtn = document.getElementById('clear-cart-btn');
    var stockIssuesContainer = document.getElementById('stock-issues-container');

    // Summary elements
    var summarySubtotal = document.getElementById('summary-subtotal');
    var summaryTax = document.getElementById('summary-tax');
    var summaryTotal = document.getElementById('summary-total');

    // Check authentication
    function isAuthenticated() {
        return localStorage.getItem('access_token') !== null;
    }

    function getAuthHeader() {
        var token = localStorage.getItem('access_token');
        return token ? { 'Authorization': 'Bearer ' + token } : {};
    }

    // Show/hide states
    function showState(state) {
        authRequired.classList.add('hidden');
        cartLoading.classList.add('hidden');
        emptyCart.classList.add('hidden');
        cartContent.classList.add('hidden');

        switch (state) {
            case 'auth':
                authRequired.classList.remove('hidden');
                break;
            case 'loading':
                cartLoading.classList.remove('hidden');
                break;
            case 'empty':
                emptyCart.classList.remove('hidden');
                break;
            case 'cart':
                cartContent.classList.remove('hidden');
                break;
        }
    }

    // Format currency
    function formatPrice(price) {
        return '$' + parseFloat(price).toFixed(2);
    }

    // Create SVG icon for trash
    function createTrashIcon() {
        var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('width', '16');
        svg.setAttribute('height', '16');
        svg.setAttribute('viewBox', '0 0 24 24');
        svg.setAttribute('fill', 'none');
        svg.setAttribute('stroke', 'currentColor');
        svg.setAttribute('stroke-width', '2');

        var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', 'M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2');
        svg.appendChild(path);

        return svg;
    }

    // Create warning icon
    function createWarningIcon() {
        var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('width', '16');
        svg.setAttribute('height', '16');
        svg.setAttribute('viewBox', '0 0 24 24');
        svg.setAttribute('fill', 'none');
        svg.setAttribute('stroke', 'currentColor');
        svg.setAttribute('stroke-width', '2');

        var circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', '12');
        circle.setAttribute('cy', '12');
        circle.setAttribute('r', '10');
        svg.appendChild(circle);

        var path1 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path1.setAttribute('d', 'M12 8v4');
        svg.appendChild(path1);

        var path2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path2.setAttribute('d', 'M12 16h.01');
        svg.appendChild(path2);

        return svg;
    }

    // Load cart
    function loadCart() {
        if (!isAuthenticated()) {
            showState('auth');
            return;
        }

        showState('loading');

        fetch(API_BASE, {
            headers: getAuthHeader()
        })
        .then(function(response) {
            if (response.status === 401) {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('user');
                showState('auth');
                return null;
            }
            return response.json();
        })
        .then(function(data) {
            if (!data) return;

            if (data.item_count === 0 || data.message === 'Your cart is empty') {
                showState('empty');
                updateHeaderCount(0);
                return;
            }

            currentCart = data;
            renderCart(data);
            validateStock();
            showState('cart');
        })
        .catch(function(error) {
            console.error('Error loading cart:', error);
            showState('empty');
        });
    }

    // Render cart items
    function renderCart(cart) {
        // Clear existing items
        while (cartItemsContainer.firstChild) {
            cartItemsContainer.removeChild(cartItemsContainer.firstChild);
        }

        cart.items.forEach(function(item) {
            var itemEl = createCartItemElement(item);
            cartItemsContainer.appendChild(itemEl);
        });

        updateSummary(cart.summary);
        updateHeaderCount(cart.summary.item_count);
    }

    // Create cart item element using safe DOM methods
    function createCartItemElement(item) {
        var div = document.createElement('div');
        div.className = 'cart-item';
        div.dataset.itemId = item.id;

        // Image
        var img = document.createElement('img');
        img.className = 'cart-item-image';
        img.src = (item.product.images && item.product.images.length > 0)
            ? item.product.images[0]
            : '/static/images/product-placeholder.png';
        img.alt = item.product.name;
        img.onerror = function() { this.src = '/static/images/product-placeholder.png'; };
        div.appendChild(img);

        // Details container
        var details = document.createElement('div');
        details.className = 'cart-item-details';

        var category = document.createElement('div');
        category.className = 'cart-item-category';
        category.textContent = item.product.category;
        details.appendChild(category);

        var name = document.createElement('div');
        name.className = 'cart-item-name';
        name.textContent = item.product.name;
        details.appendChild(name);

        // Farm name
        if (item.product.farmer_name) {
            var farm = document.createElement('div');
            farm.className = 'cart-item-farm';

            // Farm icon
            var farmIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            farmIcon.setAttribute('width', '14');
            farmIcon.setAttribute('height', '14');
            farmIcon.setAttribute('viewBox', '0 0 24 24');
            farmIcon.setAttribute('fill', 'none');
            farmIcon.setAttribute('stroke', 'currentColor');
            farmIcon.setAttribute('stroke-width', '2');
            var farmPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            farmPath.setAttribute('d', 'M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z');
            farmIcon.appendChild(farmPath);
            var farmPath2 = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            farmPath2.setAttribute('points', '9 22 9 12 15 12 15 22');
            farmIcon.appendChild(farmPath2);
            farm.appendChild(farmIcon);

            var farmText = document.createTextNode(item.product.farmer_name);
            farm.appendChild(farmText);
            details.appendChild(farm);
        }

        var unitPrice = document.createElement('div');
        unitPrice.className = 'cart-item-unit-price';
        unitPrice.textContent = formatPrice(item.unit_price) + ' / ' + item.product.unit;
        details.appendChild(unitPrice);

        var stock = document.createElement('div');
        stock.className = 'cart-item-stock';
        if (item.product.stock_quantity <= 0) {
            stock.classList.add('out');
            stock.textContent = 'Out of stock';
        } else if (item.product.stock_quantity < 10) {
            stock.classList.add('low');
            stock.textContent = 'Only ' + item.product.stock_quantity + ' left';
        } else {
            stock.classList.add('in-stock');
            stock.textContent = item.product.stock_quantity + ' in stock';
        }
        details.appendChild(stock);

        div.appendChild(details);

        // Actions container
        var actions = document.createElement('div');
        actions.className = 'cart-item-actions';

        var subtotal = document.createElement('div');
        subtotal.className = 'cart-item-subtotal';
        subtotal.textContent = formatPrice(item.subtotal);
        actions.appendChild(subtotal);

        // Quantity controls
        var quantityControls = document.createElement('div');
        quantityControls.className = 'quantity-controls';

        var decreaseBtn = document.createElement('button');
        decreaseBtn.className = 'quantity-btn decrease';
        decreaseBtn.textContent = '-';
        decreaseBtn.disabled = item.quantity <= 1;
        decreaseBtn.addEventListener('click', function() {
            updateQuantity(item.id, item.quantity - 1);
        });
        quantityControls.appendChild(decreaseBtn);

        var quantityValue = document.createElement('span');
        quantityValue.className = 'quantity-value';
        quantityValue.textContent = item.quantity;
        quantityControls.appendChild(quantityValue);

        var increaseBtn = document.createElement('button');
        increaseBtn.className = 'quantity-btn increase';
        increaseBtn.textContent = '+';
        increaseBtn.disabled = item.quantity >= item.product.stock_quantity;
        increaseBtn.addEventListener('click', function() {
            updateQuantity(item.id, item.quantity + 1);
        });
        quantityControls.appendChild(increaseBtn);

        actions.appendChild(quantityControls);

        // Remove button
        var removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.appendChild(createTrashIcon());
        var removeText = document.createTextNode(' Remove');
        removeBtn.appendChild(removeText);
        removeBtn.addEventListener('click', function() {
            removeItem(item.id);
        });
        actions.appendChild(removeBtn);

        div.appendChild(actions);

        return div;
    }

    // Update summary
    function updateSummary(summary) {
        summarySubtotal.textContent = formatPrice(summary.subtotal);
        summaryTax.textContent = formatPrice(summary.tax_amount);
        summaryTotal.textContent = formatPrice(summary.total);
    }

    // Update header count
    function updateHeaderCount(count) {
        if (count > 0) {
            headerItemCount.textContent = '(' + count + ' item' + (count !== 1 ? 's' : '') + ')';
        } else {
            headerItemCount.textContent = '';
        }

        // Also update nav cart count if exists
        var navCartCount = document.getElementById('nav-cart-count');
        if (navCartCount) {
            navCartCount.textContent = count;
            navCartCount.style.display = count > 0 ? 'flex' : 'none';
        }
    }

    // Update quantity
    function updateQuantity(itemId, newQuantity) {
        if (newQuantity < 1) return;

        fetch(API_BASE + '/items/' + itemId, {
            method: 'PUT',
            headers: Object.assign({
                'Content-Type': 'application/json'
            }, getAuthHeader()),
            body: JSON.stringify({ quantity: newQuantity })
        })
        .then(function(response) {
            return response.json().then(function(data) {
                return { ok: response.ok, data: data };
            });
        })
        .then(function(result) {
            if (!result.ok) {
                showToast(result.data.detail || 'Failed to update quantity', 'error');
                return;
            }

            if (result.data.cart) {
                currentCart = result.data.cart;
                renderCart(result.data.cart);
            }

            showToast(result.data.message, 'success');
        })
        .catch(function(error) {
            console.error('Error updating quantity:', error);
            showToast('Failed to update quantity', 'error');
        });
    }

    // Remove item
    function removeItem(itemId) {
        fetch(API_BASE + '/items/' + itemId, {
            method: 'DELETE',
            headers: getAuthHeader()
        })
        .then(function(response) {
            return response.json().then(function(data) {
                return { ok: response.ok, data: data };
            });
        })
        .then(function(result) {
            if (!result.ok) {
                showToast(result.data.detail || 'Failed to remove item', 'error');
                return;
            }

            if (result.data.cart) {
                currentCart = result.data.cart;
                renderCart(result.data.cart);
            } else {
                showState('empty');
                updateHeaderCount(0);
            }

            showToast(result.data.message, 'success');
        })
        .catch(function(error) {
            console.error('Error removing item:', error);
            showToast('Failed to remove item', 'error');
        });
    }

    // Clear cart
    function clearCart() {
        if (!confirm('Are you sure you want to clear your entire cart?')) {
            return;
        }

        fetch(API_BASE, {
            method: 'DELETE',
            headers: getAuthHeader()
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            showState('empty');
            updateHeaderCount(0);
            showToast(data.message, 'success');
        })
        .catch(function(error) {
            console.error('Error clearing cart:', error);
            showToast('Failed to clear cart', 'error');
        });
    }

    // Validate stock
    function validateStock() {
        fetch(API_BASE + '/validate', {
            headers: getAuthHeader()
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (!data.valid && data.issues.length > 0) {
                renderStockIssues(data.issues);
                checkoutBtn.disabled = true;
            } else {
                // Clear stock issues
                while (stockIssuesContainer.firstChild) {
                    stockIssuesContainer.removeChild(stockIssuesContainer.firstChild);
                }
                checkoutBtn.disabled = false;
            }
        })
        .catch(function(error) {
            console.error('Error validating stock:', error);
        });
    }

    // Render stock issues using safe DOM methods
    function renderStockIssues(issues) {
        // Clear existing
        while (stockIssuesContainer.firstChild) {
            stockIssuesContainer.removeChild(stockIssuesContainer.firstChild);
        }

        var div = document.createElement('div');
        div.className = 'stock-issues';

        var h4 = document.createElement('h4');
        h4.appendChild(createWarningIcon());
        var headerText = document.createTextNode(' Stock Issues');
        h4.appendChild(headerText);
        div.appendChild(h4);

        var ul = document.createElement('ul');
        issues.forEach(function(issue) {
            var li = document.createElement('li');
            li.textContent = (issue.product_name || 'Product') + ': ' + issue.issue;
            ul.appendChild(li);
        });
        div.appendChild(ul);

        stockIssuesContainer.appendChild(div);
    }

    // Toast notification
    function showToast(message, type) {
        type = type || 'info';
        var toast = document.createElement('div');
        toast.className = 'toast toast-' + type;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(function() {
            toast.remove();
        }, 3000);
    }

    // Event listeners
    checkoutBtn.addEventListener('click', function() {
        showToast('Checkout feature coming soon!', 'info');
    });

    clearCartBtn.addEventListener('click', clearCart);

    // Initialize
    loadCart();
})();
</script>
{% endblock %}

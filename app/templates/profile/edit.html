{% extends "base.html" %}

{% block title %}Edit Profile - {{ app_name }}{% endblock %}

{% block content %}
<div class="profile-edit-container">
    <div class="page-header">
        <a href="/dashboard" class="back-link">&larr; Back to Dashboard</a>
        <h1>Edit Profile</h1>
    </div>

    <div class="profile-sections">
        <!-- Basic Info Section -->
        <div class="profile-section">
            <div class="section-header">
                <h2>Basic Information</h2>
            </div>
            <form id="profile-form" class="profile-form">
                <div class="form-group">
                    <label for="full_name">Full Name</label>
                    <input type="text" id="full_name" name="full_name" required minlength="2" maxlength="255">
                </div>
                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" name="phone" placeholder="+91 XXXXX XXXXX">
                </div>
                <div class="form-group">
                    <label for="date_of_birth">Date of Birth</label>
                    <input type="date" id="date_of_birth" name="date_of_birth">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
            <div id="profile-message" class="message hidden"></div>
        </div>

        <!-- Avatar Section -->
        <div class="profile-section">
            <div class="section-header">
                <h2>Profile Picture</h2>
            </div>
            <div class="avatar-section">
                <div class="current-avatar" id="current-avatar">
                    <span id="avatar-initials"></span>
                    <img id="avatar-image" src="" alt="Profile" style="display: none;">
                </div>
                <div class="avatar-upload">
                    <input type="file" id="avatar-input" accept="image/jpeg,image/png,image/webp" style="display: none;">
                    <button type="button" class="btn btn-outline" onclick="document.getElementById('avatar-input').click()">
                        Upload New Picture
                    </button>
                    <p class="help-text">JPG, PNG, or WebP. Max 5MB.</p>
                </div>
            </div>
            <div id="avatar-message" class="message hidden"></div>
        </div>
    </div>
</div>

<style>
    .profile-edit-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem;
    }

    .page-header {
        margin-bottom: 2rem;
    }

    .back-link {
        color: var(--primary);
        text-decoration: none;
        font-size: 0.875rem;
    }

    .back-link:hover {
        text-decoration: underline;
    }

    .page-header h1 {
        margin: 0.5rem 0 0 0;
        color: var(--dark);
    }

    .profile-sections {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .profile-section {
        background: var(--white);
        border-radius: var(--radius-xl);
        padding: 1.5rem;
        box-shadow: var(--shadow);
    }

    .section-header h2 {
        margin: 0 0 1rem 0;
        font-size: 1.25rem;
        color: var(--dark);
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--primary);
    }

    .profile-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-group label {
        font-weight: 500;
        color: var(--text);
    }

    .form-group input {
        padding: 0.75rem;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        font-size: 1rem;
    }

    .form-group input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
    }

    .form-actions {
        margin-top: 1rem;
    }

    .avatar-section {
        display: flex;
        align-items: center;
        gap: 2rem;
    }

    .current-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--white);
        font-size: 2rem;
        font-weight: 700;
        overflow: hidden;
    }

    .current-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .help-text {
        font-size: 0.875rem;
        color: var(--text-light);
        margin-top: 0.5rem;
    }

    .message {
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        border-radius: var(--radius);
        font-size: 0.875rem;
    }

    .message.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .message.hidden {
        display: none;
    }

    @media (max-width: 600px) {
        .avatar-section {
            flex-direction: column;
            text-align: center;
        }
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    var accessToken = localStorage.getItem('access_token');
    if (!accessToken) {
        window.location.href = '/login';
    }

    function setAvatarImage(url) {
        var initialsEl = document.getElementById('avatar-initials');
        var imageEl = document.getElementById('avatar-image');
        initialsEl.style.display = 'none';
        imageEl.src = url;
        imageEl.style.display = 'block';
    }

    function setAvatarInitials(name) {
        var initialsEl = document.getElementById('avatar-initials');
        var imageEl = document.getElementById('avatar-image');
        var initials = name.split(' ').map(function(n) { return n[0]; }).join('').toUpperCase().slice(0, 2);
        initialsEl.textContent = initials;
        initialsEl.style.display = 'block';
        imageEl.style.display = 'none';
    }

    // Load current profile
    async function loadProfile() {
        try {
            var response = await fetch('/api/v1/users/profile', {
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                }
            });

            if (response.ok) {
                var profile = await response.json();
                document.getElementById('full_name').value = profile.full_name || '';
                document.getElementById('phone').value = profile.phone || '';
                document.getElementById('date_of_birth').value = profile.date_of_birth || '';

                // Set avatar
                if (profile.profile_picture_url) {
                    setAvatarImage(profile.profile_picture_url);
                } else if (profile.full_name) {
                    setAvatarInitials(profile.full_name);
                }
            } else if (response.status === 401) {
                window.location.href = '/login';
            }
        } catch (e) {
            console.error('Error loading profile:', e);
        }
    }

    loadProfile();

    // Handle profile form submission
    document.getElementById('profile-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        var messageEl = document.getElementById('profile-message');

        var data = {
            full_name: document.getElementById('full_name').value,
            phone: document.getElementById('phone').value || null,
            date_of_birth: document.getElementById('date_of_birth').value || null
        };

        try {
            var response = await fetch('/api/v1/users/profile', {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                var result = await response.json();
                messageEl.className = 'message success';
                messageEl.textContent = 'Profile updated successfully!';

                // Update localStorage
                var user = JSON.parse(localStorage.getItem('user') || '{}');
                user.full_name = data.full_name;
                user.phone = data.phone;
                localStorage.setItem('user', JSON.stringify(user));
            } else {
                var error = await response.json();
                messageEl.className = 'message error';
                messageEl.textContent = error.detail || 'Failed to update profile';
            }
        } catch (e) {
            messageEl.className = 'message error';
            messageEl.textContent = 'An error occurred. Please try again.';
        }
    });

    // Handle avatar upload
    document.getElementById('avatar-input').addEventListener('change', async function(e) {
        var file = e.target.files[0];
        if (!file) return;

        var messageEl = document.getElementById('avatar-message');
        var formData = new FormData();
        formData.append('file', file);

        try {
            var response = await fetch('/api/v1/users/profile/avatar', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                },
                body: formData
            });

            if (response.ok) {
                var result = await response.json();
                messageEl.className = 'message success';
                messageEl.textContent = 'Profile picture updated!';

                // Update avatar display using safe method
                setAvatarImage(result.profile_picture_url);
            } else {
                var error = await response.json();
                messageEl.className = 'message error';
                messageEl.textContent = error.detail || 'Failed to upload image';
            }
        } catch (e) {
            messageEl.className = 'message error';
            messageEl.textContent = 'An error occurred. Please try again.';
        }
    });
</script>
{% endblock %}
